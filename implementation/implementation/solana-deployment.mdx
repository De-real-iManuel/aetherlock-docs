---
title: "Solana Program Deployment"
description: "Complete guide for deploying AetherLock Anchor programs to Solana networks"
---

# Solana Program Deployment Guide

This guide covers the complete process of building, testing, and deploying the AetherLock Solana program using the Anchor framework. Follow these steps to deploy to devnet, testnet, or mainnet.

## Prerequisites

Ensure you have completed the [Quick Start Guide](/implementation/quick-start) and have the following installed:

- Solana CLI (v1.16.0+)
- Anchor Framework (v0.29.0+)
- Rust (v1.70.0+)
- Node.js (v18.0.0+)

## Project Structure

The Solana program is organized as follows:

```
solana-program/
├── Anchor.toml              # Anchor configuration
├── Cargo.toml              # Rust workspace configuration
├── package.json            # Node.js dependencies
├── programs/
│   └── aetherlock/
│       ├── Cargo.toml      # Program dependencies
│       └── src/
│           ├── lib.rs      # Main program entry point
│           ├── instructions/  # Instruction handlers
│           ├── state/      # Account state definitions
│           └── errors.rs   # Custom error definitions
├── tests/                  # Integration tests
├── target/                 # Build artifacts
└── migrations/             # Deployment scripts
```

## Configuration Setup

### 1. Configure Anchor.toml

Edit `solana-program/Anchor.toml` to set up your deployment configuration:

```toml
[features]
seeds = false
skip-lint = false

[programs.localnet]
aetherlock = "AEtherLockXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

[programs.devnet]
aetherlock = "AEtherLockXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

[programs.testnet]
aetherlock = "AEtherLockXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

[programs.mainnet]
aetherlock = "AEtherLockXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

[registry]
url = "https://api.apr.dev"

[provider]
cluster = "devnet"
wallet = "~/.config/solana/id.json"

[scripts]
test = "yarn run ts-mocha -p ./tsconfig.json -t 1000000 tests/**/*.ts"

[test]
startup_wait = 5000
shutdown_wait = 2000
upgradeable = true

[[test.genesis]]
address = "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"
program = "spl_token_metadata.so"

[test.validator]
url = "https://api.devnet.solana.com"
ledger = ".anchor/test-ledger"
rpc_port = 8899
bind_address = "0.0.0.0"
```

### 2. Configure Solana CLI

Set up your Solana CLI for the target network:

```bash
# For devnet deployment
solana config set --url devnet
solana config set --keypair ~/.config/solana/id.json

# For testnet deployment
solana config set --url testnet

# For mainnet deployment
solana config set --url mainnet-beta
```

### 3. Generate Program Keypair

Generate a new keypair for your program (or use existing):

```bash
cd solana-program

# Generate new program keypair
solana-keygen new --outfile target/deploy/aetherlock-keypair.json

# Get the program ID
solana-keygen pubkey target/deploy/aetherlock-keypair.json
```

Update the program ID in:
- `Anchor.toml` (programs section)
- `programs/aetherlock/src/lib.rs` (declare_id! macro)

## Build Process

### 1. Clean Previous Builds

```bash
cd solana-program

# Clean Anchor build artifacts
anchor clean

# Clean Cargo build artifacts
cargo clean
```

### 2. Build the Program

```bash
# Build the program
anchor build

# Verify build succeeded
ls -la target/deploy/
```

Expected output files:
- `aetherlock.so` - The compiled program binary
- `aetherlock-keypair.json` - Program keypair
- `idl/aetherlock.json` - Interface Definition Language file

### 3. Generate TypeScript Client

```bash
# Generate TypeScript client code
anchor build --typescript

# Install generated client dependencies
npm install
```

## Testing

### 1. Run Unit Tests

```bash
# Run Rust unit tests
cargo test

# Run with verbose output
cargo test -- --nocapture
```

### 2. Run Integration Tests

```bash
# Start local validator (in separate terminal)
solana-test-validator --reset --quiet

# Run Anchor tests
anchor test --skip-local-validator

# Or run tests with local validator startup
anchor test
```

### 3. Test Specific Functions

```bash
# Run specific test file
anchor test --skip-local-validator tests/escrow.ts

# Run with debugging
DEBUG=* anchor test --skip-local-validator
```

## Deployment

### 1. Prepare for Deployment

#### Check Account Balance

```bash
# Check SOL balance (need ~5-10 SOL for deployment)
solana balance

# Airdrop SOL on devnet/testnet if needed
solana airdrop 10
```

#### Verify Program Size

```bash
# Check program size (max 1MB for non-upgradeable, 10MB for upgradeable)
ls -lh target/deploy/aetherlock.so

# If too large, optimize build
cargo build-bpf --release
```

### 2. Deploy to Devnet

```bash
# Set cluster to devnet
solana config set --url devnet

# Deploy the program
anchor deploy --provider.cluster devnet

# Verify deployment
solana program show <PROGRAM_ID>
```

### 3. Deploy to Testnet

```bash
# Set cluster to testnet
solana config set --url testnet

# Deploy the program
anchor deploy --provider.cluster testnet

# Verify deployment
solana program show <PROGRAM_ID>
```

### 4. Deploy to Mainnet

```bash
# Set cluster to mainnet
solana config set --url mainnet-beta

# Deploy the program (requires significant SOL)
anchor deploy --provider.cluster mainnet-beta

# Verify deployment
solana program show <PROGRAM_ID>
```

## Program ID Configuration

### 1. Update Program References

After deployment, update the program ID in all relevant files:

#### Update Anchor.toml
```toml
[programs.devnet]
aetherlock = "YourActualProgramIDHere"
```

#### Update lib.rs
```rust
use anchor_lang::prelude::*;

declare_id!("YourActualProgramIDHere");

#[program]
pub mod aetherlock {
    use super::*;
    // ... program implementation
}
```

#### Update Client Code
```typescript
// In your frontend/backend code
export const AETHERLOCK_PROGRAM_ID = new PublicKey(
  "YourActualProgramIDHere"
);
```

### 2. Regenerate Client Code

```bash
# Rebuild with new program ID
anchor build

# Update TypeScript bindings
npm run build
```

## Verification Steps

### 1. Verify Program Deployment

```bash
# Check program account
solana program show <PROGRAM_ID>

# Check program logs
solana logs <PROGRAM_ID>

# Verify program is executable
solana program dump <PROGRAM_ID> program_dump.so
```

### 2. Test Program Instructions

```bash
# Run post-deployment tests
anchor test --skip-build --skip-deploy

# Test specific instruction
node scripts/test-create-escrow.js
```

### 3. Verify IDL Upload

```bash
# Check if IDL is uploaded to Anchor registry
anchor idl fetch <PROGRAM_ID>

# Upload IDL if not present
anchor idl init <PROGRAM_ID> --filepath target/idl/aetherlock.json
```

## Upgrades and Maintenance

### 1. Upgrade Program

```bash
# Build new version
anchor build

# Upgrade deployed program
anchor upgrade <PROGRAM_ID> --provider.cluster devnet

# Verify upgrade
solana program show <PROGRAM_ID>
```

### 2. Update IDL

```bash
# Update IDL after program upgrade
anchor idl upgrade <PROGRAM_ID> --filepath target/idl/aetherlock.json
```

### 3. Close Program (if needed)

```bash
# Close program and recover rent (IRREVERSIBLE)
solana program close <PROGRAM_ID> --recipient <RECIPIENT_ADDRESS>
```

## Common Build Errors and Fixes

### Error: "Program ID mismatch"

**Cause**: Program ID in code doesn't match keypair

**Fix**:
```bash
# Get correct program ID
solana-keygen pubkey target/deploy/aetherlock-keypair.json

# Update lib.rs with correct ID
# Update Anchor.toml with correct ID
```

### Error: "Insufficient funds"

**Cause**: Not enough SOL for deployment

**Fix**:
```bash
# Check balance
solana balance

# Airdrop more SOL (devnet/testnet only)
solana airdrop 10

# Or transfer SOL from another account
```

### Error: "Program size too large"

**Cause**: Compiled program exceeds size limits

**Fix**:
```bash
# Optimize build
cargo build-bpf --release

# Remove debug symbols
strip target/deploy/aetherlock.so

# Check dependencies for bloat
cargo tree
```

### Error: "Account not found"

**Cause**: Program not deployed or wrong cluster

**Fix**:
```bash
# Verify cluster configuration
solana config get

# Check program exists on cluster
solana program show <PROGRAM_ID>

# Deploy if not found
anchor deploy
```

### Error: "Anchor version mismatch"

**Cause**: Different Anchor versions between build and runtime

**Fix**:
```bash
# Check Anchor version
anchor --version

# Update Anchor.toml version
[toolchain]
anchor_version = "0.29.0"

# Rebuild
anchor build
```

### Error: "BPF loader error"

**Cause**: Program binary corruption or invalid format

**Fix**:
```bash
# Clean and rebuild
anchor clean
cargo clean
anchor build

# Verify binary integrity
file target/deploy/aetherlock.so
```

## Security Considerations

### 1. Program Authority

```bash
# Set program upgrade authority
solana program set-upgrade-authority <PROGRAM_ID> <NEW_AUTHORITY>

# Make program immutable (IRREVERSIBLE)
solana program set-upgrade-authority <PROGRAM_ID> --final
```

### 2. Keypair Security

```bash
# Secure program keypair
chmod 600 target/deploy/aetherlock-keypair.json

# Use hardware wallet for mainnet
solana config set --keypair usb://ledger
```

### 3. Deployment Verification

```bash
# Verify program hash matches source
anchor verify <PROGRAM_ID>

# Check program upgrade authority
solana program show <PROGRAM_ID> | grep "Upgrade Authority"
```

## Monitoring and Maintenance

### 1. Program Monitoring

```bash
# Monitor program logs
solana logs <PROGRAM_ID> --follow

# Check program account info
solana account <PROGRAM_ID>

# Monitor transaction volume
solana transaction-history <PROGRAM_ID>
```

### 2. Performance Metrics

```bash
# Check compute unit usage
solana logs <PROGRAM_ID> | grep "consumed"

# Monitor rent exemption
solana rent <ACCOUNT_SIZE>
```

### 3. Backup and Recovery

```bash
# Backup program binary
cp target/deploy/aetherlock.so backups/aetherlock-v1.0.0.so

# Backup program keypair
cp target/deploy/aetherlock-keypair.json backups/

# Backup IDL
cp target/idl/aetherlock.json backups/
```

## Next Steps

After successful deployment:

1. **Update Frontend**: Configure frontend to use deployed program ID
2. **Update Backend**: Update backend services with new program ID
3. **Test Integration**: Run end-to-end tests with deployed program
4. **Monitor Performance**: Set up monitoring and alerting
5. **Document Changes**: Update deployment documentation

For frontend and backend configuration, see:
- [Frontend Setup Guide](/implementation/frontend-setup)
- [Backend Setup Guide](/implementation/backend-setup)
- [Environment Variables Reference](/implementation/environment-variables)