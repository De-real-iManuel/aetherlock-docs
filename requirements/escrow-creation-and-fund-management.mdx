# Escrow Creation and Fund Management

## Overview

This document defines the functional requirements for AetherLock's core escrow creation and fund management system. The escrow mechanism enables secure, trustless transactions between clients and freelancers across multiple blockchain networks, with funds locked until task completion is verified through the Proof of Task Verification (PoTV) mechanism.

## Implementation Status

### Current Features (Implemented - Devnet)
- âœ… **Escrow Creation**: Create escrow contracts with task details and payment terms
- âœ… **Fund Deposit**: Lock funds in Solana escrow PDAs
- âœ… **State Management**: Enforce valid state transitions (Created â†’ Funded â†’ Verified â†’ Completed)
- âœ… **Automatic Fund Release**: Release funds after AI verification approval
- âœ… **Platform Fee Collection**: 10% fee automatically collected on completion
- âœ… **Escrow Querying**: View and filter escrows by status

### Planned Features (Future Roadmap)
- ðŸ”„ **Deadline Enforcement**: Automatic refunds for missed deadlines
- ðŸ”„ **Escrow Cancellation**: Cancel unfunded escrows
- ðŸ”„ **Cross-Chain Support**: ZetaChain integration for Ethereum, TON, Sui
- ðŸ”„ **Somnia Settlement**: High-speed settlement layer integration
- ðŸ”„ **Advanced Filtering**: Export and analytics features

## User Stories and Acceptance Criteria

### User Story 1: Client Creates Escrow Contract

**As a** client hiring a freelancer  
**I want to** create an escrow contract with clear terms and locked funds  
**So that** I can ensure the freelancer is committed to completing the work while protecting my payment until delivery

#### Acceptance Criteria

1. **WHEN** I initiate escrow creation **THEN** the system SHALL display a form requesting task description, payment amount, deadline, and freelancer wallet address
2. **WHEN** I submit the escrow form **THEN** the system SHALL validate all required fields and display clear error messages for invalid inputs
3. **WHEN** I confirm escrow creation **THEN** the system SHALL generate a unique escrow account using a Program Derived Address (PDA) on Solana
4. **WHEN** the escrow account is created **THEN** the system SHALL emit an EscrowCreated event with escrow ID, client address, freelancer address, amount, and deadline
5. **WHEN** escrow creation fails **THEN** the system SHALL revert the transaction and return detailed error information without charging gas fees

### User Story 2: Client Deposits Funds into Escrow

**As a** client with a created escrow contract  
**I want to** deposit the agreed payment amount into the escrow  
**So that** the freelancer can see the funds are secured and begin work with confidence

#### Acceptance Criteria

1. **WHEN** I initiate fund deposit **THEN** the system SHALL verify I have sufficient balance in my connected wallet
2. **WHEN** I approve the deposit transaction **THEN** the system SHALL transfer the exact escrow amount from my wallet to the escrow PDA account
3. **WHEN** the deposit is successful **THEN** the system SHALL update the escrow state to "Funded" and emit a FundsDeposited event
4. **WHEN** I attempt to deposit more than the escrow amount **THEN** the system SHALL reject the transaction and display an error message
5. **WHEN** the escrow is already funded **THEN** the system SHALL prevent duplicate deposits and display the current escrow status

### User Story 3: Freelancer Views Escrow Details

**As a** freelancer assigned to an escrow  
**I want to** view the complete escrow details including task description, payment amount, and deadline  
**So that** I can understand the requirements and confirm the terms before starting work

#### Acceptance Criteria

1. **WHEN** I connect my wallet **THEN** the system SHALL display all escrows where I am listed as the freelancer
2. **WHEN** I select an escrow **THEN** the system SHALL display task description, payment amount, deadline, client address, and current status
3. **WHEN** the escrow is funded **THEN** the system SHALL display a visual indicator showing funds are secured
4. **WHEN** I check escrow history **THEN** the system SHALL display all state transitions with timestamps
5. **WHEN** the escrow has evidence submitted **THEN** the system SHALL display links to the submitted evidence on IPFS

### User Story 4: System Manages Escrow State Transitions

**As the** AetherLock protocol  
**I want to** enforce valid state transitions for escrow contracts  
**So that** funds are protected and can only be released according to predefined rules

#### Acceptance Criteria

1. **WHEN** an escrow is created **THEN** the system SHALL initialize the state as "Created" with all required fields populated
2. **WHEN** funds are deposited **THEN** the system SHALL transition the state from "Created" to "Funded" only if the deposit amount matches the escrow amount
3. **WHEN** evidence is submitted **THEN** the system SHALL transition the state from "Funded" to "AwaitingVerification" and store the IPFS hash
4. **WHEN** AI verification completes **THEN** the system SHALL transition to "Approved", "Rejected", or "InDispute" based on the verification result
5. **WHEN** funds are released **THEN** the system SHALL transition to "Completed" and prevent any further state changes

### User Story 5: Automated Fund Release After Verification

**As a** freelancer who completed verified work  
**I want** funds to be automatically released to my wallet  
**So that** I receive payment immediately without waiting for manual approval

#### Acceptance Criteria

1. **WHEN** AI verification approves my work **THEN** the system SHALL automatically transfer funds from the escrow PDA to my wallet address
2. **WHEN** the transfer is successful **THEN** the system SHALL update the escrow state to "Completed" and emit a FundsReleased event
3. **WHEN** the transfer includes platform fees **THEN** the system SHALL deduct 10% and route it to the treasury account before releasing the remaining 90% to the freelancer
4. **WHEN** the blockchain transaction fails **THEN** the system SHALL retry the transfer up to 3 times with exponential backoff
5. **WHEN** all retries fail **THEN** the system SHALL mark the escrow as "PendingManualRelease" and notify administrators

### User Story 6: Client Cancels Unfunded Escrow

**As a** client who created an escrow but hasn't funded it  
**I want to** cancel the escrow contract  
**So that** I can remove it from my dashboard if I no longer need the service

#### Acceptance Criteria

1. **WHEN** I request escrow cancellation **THEN** the system SHALL verify the escrow state is "Created" (not yet funded)
2. **WHEN** the escrow is unfunded **THEN** the system SHALL allow cancellation and update the state to "Cancelled"
3. **WHEN** the escrow is already funded **THEN** the system SHALL reject the cancellation request and display an error message
4. **WHEN** cancellation is successful **THEN** the system SHALL emit an EscrowCancelled event with the escrow ID and timestamp
5. **WHEN** I attempt to cancel an escrow I didn't create **THEN** the system SHALL reject the request with an "Unauthorized" error

### User Story 7: Deadline Enforcement and Refunds

**As a** client with a funded escrow  
**I want** automatic refunds if the freelancer doesn't submit work by the deadline  
**So that** my funds aren't locked indefinitely in incomplete projects

#### Acceptance Criteria

1. **WHEN** the deadline passes without evidence submission **THEN** the system SHALL mark the escrow as eligible for refund
2. **WHEN** I request a refund after the deadline **THEN** the system SHALL verify no evidence was submitted and the deadline has passed
3. **WHEN** refund conditions are met **THEN** the system SHALL transfer the full escrow amount back to my wallet address
4. **WHEN** the refund is successful **THEN** the system SHALL update the escrow state to "Refunded" and emit a FundsRefunded event
5. **WHEN** evidence was submitted before the deadline **THEN** the system SHALL reject the refund request even if verification is still pending

### User Story 8: Multi-Chain Fund Management

**Implementation Status**: ðŸ”„ **PARTIALLY IMPLEMENTED** - Solana implemented, cross-chain planned

**As a** user operating across multiple blockchains  
**I want** to create escrows on different networks with seamless fund management  
**So that** I can work with freelancers regardless of their preferred blockchain

#### Acceptance Criteria

1. âœ… **WHEN** I create an escrow on Solana **THEN** the system SHALL lock SOL or SPL tokens in the Solana escrow program *(IMPLEMENTED - Devnet)*
2. ðŸ”„ **WHEN** I create an escrow on Ethereum **THEN** the system SHALL lock ETH or ERC-20 tokens in the Ethereum escrow contract via ZetaChain *(PLANNED - Phase 3)*
3. ðŸ”„ **WHEN** cross-chain settlement occurs **THEN** the system SHALL use ZetaChain's Universal App to route messages and coordinate fund releases *(PLANNED - Phase 3)*
4. ðŸ”„ **WHEN** I view my escrows **THEN** the system SHALL display escrows from all connected networks in a unified dashboard *(PLANNED)*
5. âœ… **WHEN** network-specific errors occur **THEN** the system SHALL provide clear error messages indicating which blockchain encountered the issue *(IMPLEMENTED)*

### User Story 9: Escrow Fee Management

**As the** AetherLock protocol  
**I want to** collect a 10% platform fee on all successful escrow completions  
**So that** the protocol generates sustainable revenue while providing value to users

#### Acceptance Criteria

1. **WHEN** funds are released to a freelancer **THEN** the system SHALL calculate 10% of the escrow amount as the platform fee
2. **WHEN** the fee is calculated **THEN** the system SHALL transfer the fee amount to the designated treasury account
3. **WHEN** the remaining funds are calculated **THEN** the system SHALL transfer 90% of the escrow amount to the freelancer
4. **WHEN** fee collection fails **THEN** the system SHALL still release funds to the freelancer and log the fee collection error for manual resolution
5. **WHEN** an escrow is refunded **THEN** the system SHALL not collect any platform fees and return the full amount to the client

### User Story 10: Escrow Query and Filtering

**As a** user with multiple escrows  
**I want to** filter and search my escrows by status, date, and amount  
**So that** I can quickly find specific contracts and track my transaction history

#### Acceptance Criteria

1. **WHEN** I access my escrow dashboard **THEN** the system SHALL display all escrows where I am either the client or freelancer
2. **WHEN** I filter by status **THEN** the system SHALL show only escrows matching the selected status (Created, Funded, Completed, etc.)
3. **WHEN** I sort by date **THEN** the system SHALL order escrows by creation date, deadline, or completion date based on my selection
4. **WHEN** I search by amount **THEN** the system SHALL filter escrows within the specified payment range
5. **WHEN** I export escrow data **THEN** the system SHALL generate a CSV file with all escrow details for accounting purposes

## Technical Requirements

### Smart Contract Requirements

#### Solana Anchor Program
- **Account Structure**: Escrow accounts use PDAs derived from client address, freelancer address, and nonce
- **State Management**: Escrow state stored on-chain with atomic state transitions
- **Access Control**: Only authorized parties (client, freelancer, AI verifier) can modify escrow state
- **Event Emission**: All state changes emit events for off-chain indexing and notifications

#### Cross-Chain Contracts
- **ZetaChain Universal App**: Handles cross-chain message routing and fund coordination
- **Somnia Settlement**: Fast finality settlement layer for high-throughput escrow operations
- **Gateway Integration**: Secure communication between Solana, ZetaChain, and Somnia networks

### Performance Requirements
- **Escrow Creation**: Complete escrow creation within 5 seconds including blockchain confirmation
- **Fund Deposit**: Process fund deposits within 10 seconds on Solana, 30 seconds on Ethereum
- **Fund Release**: Automatic fund release within 15 seconds of verification approval
- **Query Performance**: Load escrow dashboard with up to 100 escrows within 2 seconds

### Security Requirements
- **Reentrancy Protection**: Prevent reentrancy attacks on fund transfer functions
- **Integer Overflow**: Use checked arithmetic for all amount calculations
- **Access Control**: Enforce strict permission checks on all state-modifying functions
- **Signature Verification**: Validate all transactions are signed by authorized parties

### Data Integrity Requirements
- **Immutable Records**: Escrow creation parameters cannot be modified after initialization
- **Audit Trail**: Complete history of all state transitions stored on-chain
- **Consistency**: Escrow state always reflects the actual fund balance in the PDA
- **Atomicity**: All fund transfers are atomic operations that either fully succeed or fully revert

## Error Handling

### User-Facing Errors
- **Insufficient Balance**: "Your wallet balance is insufficient to fund this escrow. Required: X SOL, Available: Y SOL"
- **Invalid Deadline**: "Deadline must be at least 24 hours in the future"
- **Unauthorized Action**: "You are not authorized to perform this action on this escrow"
- **Duplicate Deposit**: "This escrow is already funded. Current status: Funded"

### System Errors
- **Network Failure**: Retry mechanism with exponential backoff for blockchain transactions
- **PDA Derivation Error**: Log error and notify administrators for manual investigation
- **Cross-Chain Sync Failure**: Queue message for retry and display pending status to users
- **Fee Collection Failure**: Release funds to freelancer and flag for manual fee collection

## Integration Points

### Frontend Integration
- **Wallet Adapters**: Support for Phantom, Solflare, Backpack (Solana), MetaMask (Ethereum)
- **Transaction Signing**: Clear transaction preview before user signs
- **Real-Time Updates**: WebSocket connection for live escrow status updates
- **Error Display**: User-friendly error messages with actionable next steps

### Backend Integration
- **Blockchain Indexer**: Index all escrow events for fast querying
- **Notification Service**: Send email/push notifications for escrow state changes
- **Analytics**: Track escrow creation, completion rates, and average amounts
- **Admin Dashboard**: Tools for monitoring and manually resolving stuck escrows

### AI Verification Integration
- **Verification Trigger**: Automatically trigger AI verification when evidence is submitted
- **Result Processing**: Process AI verification results and update escrow state accordingly
- **Confidence Thresholds**: Route low-confidence verifications to human review
- **Feedback Loop**: Store verification results for improving AI accuracy over time
